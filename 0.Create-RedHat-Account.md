

# 1. 踏み台サーバへSSHログイン

```
ssh lab-user@bastion.foo.bar.opentlc.com
```


# 2. install-config.yamlの作成

```
vi install-config.yaml
```

```
apiVersion: v1
baseDomain: sandboxXXX.opentlc.com
compute:
- architecture: amd64
  hyperthreading: Enabled
  name: worker
  platform: 
    aws:
      type: m5.4xlarge # インスタンスタイプ
  replicas: 3 
controlPlane:
  architecture: amd64
  hyperthreading: Enabled
  name: master
  platform: {}
  replicas: 3
metadata:
  creationTimestamp: null
  name: demo
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 10.0.0.0/16
  networkType: OVNKubernetes
  serviceNetwork:
  - 172.30.0.0/16
platform:
  aws:
    region: ap-northeast-1
publish: External
pullSecret: 'YOUR_PULL_SECRET'
```

# 3. OpenShiftをIPIでインストール

```
[lab-user@bastion ~]$ openshift-install create cluster --dir=./config
? SSH Public Key /home/lab-user/.ssh/4whjwkey.pub
? Platform aws
INFO Credentials loaded from the "default" profile in file "/home/lab-user/.aws/credentials" 
? Region us-east-1
? Base Domain sandbox3257.opentlc.com
? Cluster Name virt
? Pull Secret [? for help] ********************************************************************************************************************INFO Successfully populated MCS CA cert information: root-ca 2035-07-08T09:35:56Z 2025-07-10T09:35:56Z 
INFO Successfully populated MCS TLS cert information: root-ca 2035-07-08T09:35:56Z 2025-07-10T09:35:56Z 
WARNING Following quotas ec2/L-0263D0A3 (us-east-1) are available but will be completely used pretty soon.
```

## インストール完了を確認

```
export KUBECONFIG=./auth/kubeconfig
oc get co
oc get machines -n openshift-machine-api
```

# AWSベアメタルインスタンスをクラスタに追加

```
oc get machineset -A | grep worker-ap-northeast-1a | awk '{print $2}' | sed 's/-worker.*//'
export infrastructure_id=$(oc get machineset -A | grep worker-ap-northeast-1a | awk '{print $2}' | sed 's/-worker.*//')
```

$ oc get configmap/coreos-bootimages \
-n openshift-machine-config-operator \
-o jsonpath='{.data.stream}' | jq \
-r '.architectures.<arch>.images.aws.regions."<region>".image'

```
vi machine-bm.yaml
```

```
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  name: ${infrastructure_ID}-bm-worker-ap-northeast-1a
  namespace: openshift-machine-api
  labels:
    machine.openshift.io/cluster-api-cluster: ${infrastructure_ID}
spec:
  replicas: 2
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: ${infrastructure_ID}
      machine.openshift.io/cluster-api-machineset: ${infrastructure_ID}-bm-worker-ap-northeast-1a
  template:
    metadata:
      labels:
        machine.openshift.io/cluster-api-cluster: ${infrastructure_ID}
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: ${infrastructure_ID}-bm-worker-ap-northeast-1a
    spec:
      lifecycleHooks: {}
      metadata:
        labels:
          node-role.kubernetes.io/worker: ""
      providerSpec:
        value:
          userDataSecret:
            name: worker-user-data
          placement:
            availabilityZone: ap-northeast-1a
            region: ap-northeast-1
          credentialsSecret:
            name: aws-cloud-credentials
          instanceType: c5n.metal
          metadata:
            creationTimestamp: null
          blockDevices:
            - ebs:
                encrypted: true
                iops: 0
                kmsKey:
                  arn: ''
                volumeSize: 120
                volumeType: gp3
          securityGroups:
            - filters:
                - name: 'tag:Name'
                  values:
                    - ${infrastructure_ID}-node
            - filters:
                - name: 'tag:Name'
                  values:
                    - ${infrastructure_ID}-lb
          kind: AWSMachineProviderConfig
          metadataServiceOptions: {}
          tags:
            - name: kubernetes.io/cluster/${infrastructure_ID}
              value: owned
          deviceIndex: 0
          ami:
            id: ${ami_id}
          subnet:
            filters:
              - name: 'tag:Name'
                values:
                  - ${infrastructure_ID}-subnet-private-ap-northeast-1a
          apiVersion: machine.openshift.io/v1beta1
          iamInstanceProfile:
            id: ${infrastructure_ID}-worker-profile
```

```
cat machine-bm.yaml | envsubst | oc apply -f -
oc get machineset -A
NAMESPACE               NAME                                   DESIRED   CURRENT   READY   AVAILABLE   AGE
openshift-machine-api   demo-kh8cz-bm-worker-ap-northeast-1a   1         1                             4m50s
openshift-machine-api   demo-kh8cz-worker-ap-northeast-1a      1         1         1       1           83m
openshift-machine-api   demo-kh8cz-worker-ap-northeast-1c      1         1         1       1           83m
openshift-machine-api   demo-kh8cz-worker-ap-northeast-1d      1         1         1       1           83m
```

# OpenShift Data Foundationのインストール

# デフォルトストレージクラスの変更

ODFでStorage Systemを作成してから、OpenShift VirtualizationのHyper Converged CRを作成するまでの間に行う重要なことがあります。
デフォルトのStorage ClassをODFで作成した ocs-storagecluster-ceph-rbdに変更します。
この変更によって、この後作成するHyper Converged CRによって仮想マシンテンプレートのOSイメージ保存先が変更されます。デフォルトの gp2だとRWX属性ではないため、gp2で作成された仮想マシンでライブマイグレーションが実施できません。

# OpenShift Virtualizationのインストール